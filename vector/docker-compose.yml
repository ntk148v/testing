version: "3.8"

services:
  # The Vector service. It collects logs and sends them to clickhouse.
  vector:
    image: timberio/vector:0.49.0-debian
    container_name: vector
    restart: unless-stopped
    volumes:
      # Mount the local vector.yaml config file into the container.
      - ./vector.yaml:/etc/vector/vector.yaml
      # Mount the host's /var/log directory for log collection.
      # Be sure to adjust the path if your logs are elsewhere.
      - /var/log:/var/log:ro
    ports:
      # Expose Vector's API for metrics and health checks.
      - "8686:8686"
    depends_on:
      - clickhouse
      - victorialogs
    # Pass environment variables to the Vector container.
    environment:
      - HOSTNAME=${HOSTNAME}
      - VECTOR_LOG=debug

  # The clickhouse service. It receives and stores the logs.
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    ports:
      # ClickHouse native client port (used by Vector)
      - "9000:9000"
      # ClickHouse HTTP port (for external queries, not used by Vector in this config)
      - "8123:8123"
    volumes:
      # Persist the data and logs for ClickHouse
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    environment:
      # Define a user and password for the ClickHouse database.
      # These credentials are used by Vector to connect.
      - CLICKHOUSE_USER=user
      - CLICKHOUSE_PASSWORD=password
      - CLICKHOUSE_DB=logs

  ch-ui:
    image: ghcr.io/caioricciuti/ch-ui:latest
    container_name: ch_ui
    restart: always
    ports:
      - "5521:5521"
    depends_on:
      - clickhouse
    environment:
      # Core ClickHouse Configuration
      VITE_CLICKHOUSE_URL: "http://localhost:8123"
      VITE_CLICKHOUSE_USER: "user"
      VITE_CLICKHOUSE_PASS: "password"
      # Optional: Advanced Features
      VITE_CLICKHOUSE_USE_ADVANCED: "true"
      VITE_CLICKHOUSE_CUSTOM_PATH: ""
      VITE_CLICKHOUSE_REQUEST_TIMEOUT: "30000"
      # Optional: Reverse Proxy Support
      VITE_BASE_PATH: "/"

  # The VictoriaLogs service. It receives and stores the logs.
  victorialogs:
    image: victoriametrics/victoria-logs:v1.29.0
    container_name: victorialogs
    restart: unless-stopped
    volumes:
      # Persist the data outside the container for long-term storage.
      # This prevents log data loss if the container is removed.
      - victoria-logs-data:/victorialogs-data
    ports:
      # Expose the port for log ingestion (TCP, UDP) and the built-in UI.
      - "9428:9428"
      - "8428:8428"
    command:
      # Set the data storage directory.
      - "--storageDataPath=/victorialogs-data"

volumes:
  # Define the volume for clickhouse data persistence.
  clickhouse-data:
  clickhouse-logs:
  victoria-logs-data:
